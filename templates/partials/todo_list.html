<div class="card scrollable-card" id="todos-section" hx-get="/partials/todos" hx-trigger="sse:todos, sse:worktrees"
    hx-swap="outerHTML">
    <div class="card-header">
        <h2 class="card-title"><span class="icon">üìã</span> TODOs</h2>
    </div>

    <div class="card-content">
        <!-- Add Todo Form -->
        <div class="input-form-container">
            <form hx-post="/api/todo" hx-swap="none" hx-on::after-request="this.reset()" class="input-group">
                <input type="text" name="content" placeholder="Add a new todo..." required autocomplete="off">
                <label class="checkbox-container" title="Create a git worktree for this todo">
                    <input type="checkbox" name="create_worktree" value="true">
                    <span class="icon">üåø</span>
                </label>
                <button type="submit">
                    <span>‚úÖ</span> Add
                </button>
            </form>
        </div>

        <!-- Todo List -->
        <div class="list-container">
            {% if todos and todos|length > 0 %}
            <ul class="todo-list">
                {% for todo in todos %}
                <li class="todo-item {{ todo.status }}" data-todo-id="{{ todo.todo_id }}">
                    <div class="todo-main" onclick="toggleTodoMenu(event, '{{ todo.todo_id }}')">
                        <span class="todo-index">{{ todo.todo_id }}</span>
                        <span class="todo-content">{{ todo.content_html | safe }}</span>
                        {% if todo.worktree_requested %}
                        <span class="worktree-icon" title="Worktree requested">üåø</span>
                        {% endif %}
                        <span class="todo-status {{ todo.status }}">{{ todo.status }}</span>
                        <button class="btn-scrap-link" onclick="scrollToRelatedScraps(event, {{ todo.todo_id }})"
                            title="Jump to related scraps">
                            üìù
                        </button>
                        <span class="todo-menu-indicator">‚ãÆ</span>
                    </div>
                    {% if todo.worktree_paths and todo.worktree_paths|length > 0 %}
                    <div class="todo-worktrees">
                        {% for path in todo.worktree_paths %}
                        <div class="worktree-path" title="{{ path }}">üìÇ {{ path }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>

            <!-- Menus (outside of list items to avoid opacity inheritance) -->
            {% for todo in todos %}
            <div class="todo-menu" id="todo-menu-{{ todo.todo_id }}" style="display: none;">
                {% if todo.status == 'pending' %}
                <button class="menu-item btn-primary" hx-patch="/api/todo/{{ todo.todo_id }}/next"
                    hx-target="#todos-section" hx-swap="none" onclick="event.stopPropagation()">
                    <span class="menu-icon">‚¨ÜÔ∏è</span>
                    <span class="menu-label">Make Next</span>
                </button>
                {% endif %}
                {% if todo.status != 'done' %}
                <button class="menu-item btn-success" hx-patch="/api/todo/{{ todo.todo_id }}/done"
                    hx-target="#todos-section" hx-swap="none" onclick="event.stopPropagation()">
                    <span class="menu-icon">‚úì</span>
                    <span class="menu-label">Mark as Done</span>
                </button>
                {% endif %}
                {% if todo.status != 'pending' %}
                <button class="menu-item btn-warning" hx-patch="/api/todo/{{ todo.todo_id }}/pending"
                    hx-target="#todos-section" hx-swap="none" onclick="event.stopPropagation()">
                    <span class="menu-icon">‚Üª</span>
                    <span class="menu-label">Mark as Pending</span>
                </button>
                {% endif %}
                {% if todo.status != 'cancelled' %}
                <button class="menu-item btn-secondary" hx-patch="/api/todo/{{ todo.todo_id }}/cancelled" hx-swap="none"
                    onclick="event.stopPropagation()">
                    <span class="menu-icon">‚úï</span>
                    <span class="menu-label">Cancel</span>
                </button>
                {% endif %}
                <button class="menu-item btn-danger" hx-delete="/api/todo/{{ todo.todo_id }}" hx-target="#todos-section"
                    hx-swap="none" hx-confirm="Delete this todo?" onclick="event.stopPropagation()">
                    <span class="menu-icon">üóëÔ∏è</span>
                    <span class="menu-label">Delete</span>
                </button>
            </div>
            {% endfor %}

            {% else %}
            <div class="empty-state">
                <div class="icon">‚ú®</div>
                <p>No todos yet. Add one above!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>