{% extends "base.html" %}

{% block title %}
{% if task %}Task #{{ task.id }}: {{ task.name }}{% else %}Track WebUI{% endif %}
{% endblock %}

{% block content %}
{% if task %}
<!-- Task Header -->
<header class="task-header">
    <button class="btn-collapse" onclick="toggleMetadata()" id="collapse-btn">
        <span id="collapse-icon">‚ñº</span> Metadata
    </button>
    <h1>{{ task.name }}</h1>
    <div class="task-meta">
        {% if task.ticket_id %}
        <span class="badge">{{ task.ticket_id }}</span>
        {% else %}
        <span class="task-id">Task #{{ task.id }}</span>
        {% endif %}
    </div>
</header>

<!-- Collapsible Metadata Section -->
<div id="metadata-section">
    <!-- 2-Pane Layout for Description and Ticket -->
    <div class="two-pane-layout">
        <!-- Description Section (Left) -->
        {% include "partials/description.html" %}

        <!-- Ticket Section (Right) -->
        {% include "partials/ticket.html" %}
    </div>

    <!-- 2-Pane Layout for Repositories and Links -->
    <div class="two-pane-layout">
        <!-- Repositories Section (Left) -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title"><span class="icon">üìÅ</span> Repositories</h2>
            </div>
            {% if repos and repos|length > 0 %}
            <div class="repo-list">
                {% for repo in repos %}
                <div class="repo-item">
                    <span class="repo-path">{{ repo.repo_path }}</span>
                    {% if repo.base_branch %}
                    <span class="todo-status pending">{{ repo.base_branch }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">No repositories registered.</div>
            {% endif %}
        </div>

        <!-- Links Section (Right) -->
        {% include "partials/links.html" %}
    </div>
</div>

<!-- 2-Pane Layout for TODOs and Scraps -->
<div class="two-pane-layout">
    <!-- TODOs Section (Left) -->
    {% include "partials/todo_list.html" %}

    <!-- Scraps Section (Right) -->
    {% include "partials/scrap_list.html" %}
</div>
{% else %}
<!-- No Task State -->
<div class="no-task">
    <div class="icon">üìã</div>
    <h2>No Active Task</h2>
    <p>Create a new task or switch to an existing one to get started.</p>
    <p style="margin-top: 1rem;">
        Run <code>track new "Task name"</code> to create a new task.
    </p>
</div>
{% endif %}

<script>
    function toggleMetadata() {
        const section = document.getElementById('metadata-section');
        const icon = document.getElementById('collapse-icon');

        if (section.style.display === 'none') {
            section.style.display = 'block';
            icon.textContent = '‚ñº';
            localStorage.setItem('metadataCollapsed', 'false');
        } else {
            section.style.display = 'none';
            icon.textContent = '‚ñ∂';
            localStorage.setItem('metadataCollapsed', 'true');
        }
    }

    // Function to restore metadata collapse state
    function restoreMetadataState() {
        const collapsed = localStorage.getItem('metadataCollapsed') === 'true';
        if (collapsed) {
            const section = document.getElementById('metadata-section');
            const icon = document.getElementById('collapse-icon');
            if (section && icon) {
                section.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }
    }

    // Initialize metadata section state from localStorage
    document.addEventListener('DOMContentLoaded', restoreMetadataState);

    // Restore state after HTMX content swap and settle
    document.body.addEventListener('htmx:afterSwap', restoreMetadataState);
    document.body.addEventListener('htmx:afterSettle', restoreMetadataState);


</script>
{% endblock %}