{% extends "base.html" %}

{% block title %}
{% if task %}Task #{{ task.id }}: {{ task.name }}{% else %}Track WebUI{% endif %}
{% endblock %}

{% block content %}
{% if task %}
<!-- Task Header -->
<header class="task-header">
    <h1>{{ task.name }}</h1>
    <div class="task-meta">
        Task #{{ task.id }}
        {% if task.ticket_id %}
        <span class="badge">{{ task.ticket_id }}</span>
        {% endif %}
    </div>
</header>

<!-- Description -->
<div class="card" id="description-section">
    <div class="card-header">
        <h2 class="card-title"><span class="icon">ğŸ“</span> Description</h2>
        <button class="btn-edit" onclick="toggleDescEdit()">âœï¸ Edit</button>
    </div>
    {% if task.description %}
    <div class="description" id="desc-display">{{ task.description }}</div>
    {% else %}
    <div class="description text-muted" id="desc-display">No description set.</div>
    {% endif %}
    <form id="desc-edit-form" style="display: none;" hx-post="/api/description" hx-target="#description-section"
        hx-swap="outerHTML">
        <textarea name="description" rows="4"
            placeholder="Enter task description...">{{ task.description or '' }}</textarea>
        <div class="form-actions">
            <button type="submit" class="btn-primary">ğŸ’¾ Save</button>
            <button type="button" class="btn-secondary" onclick="toggleDescEdit()">âœ– Cancel</button>
        </div>
    </form>
</div>

<!-- Ticket Information -->
<div class="card" id="ticket-section">
    <div class="card-header">
        <h2 class="card-title"><span class="icon">ğŸ«</span> Ticket</h2>
        <button class="btn-edit" onclick="toggleTicketEdit()">âœï¸ Edit</button>
    </div>
    <div id="ticket-display">
        {% if task.ticket_id %}
        <div class="ticket-info">
            <div class="ticket-id">{{ task.ticket_id }}</div>
            {% if task.ticket_url %}
            <a href="{{ task.ticket_url }}" target="_blank" class="ticket-url">ğŸ”— Open Ticket</a>
            {% endif %}
        </div>
        {% else %}
        <div class="text-muted">No ticket linked.</div>
        {% endif %}
    </div>
    <form id="ticket-edit-form" style="display: none;" hx-post="/api/ticket" hx-target="#ticket-section"
        hx-swap="outerHTML">
        <div class="input-group" style="margin-bottom: 0.5rem;">
            <input type="text" name="ticket_id" placeholder="Ticket ID (e.g., PROJ-123)"
                value="{{ task.ticket_id or '' }}" required>
        </div>
        <div class="input-group">
            <input type="text" name="ticket_url" placeholder="Ticket URL (optional)"
                value="{{ task.ticket_url or '' }}">
        </div>
        <div class="form-actions">
            <button type="submit" class="btn-primary">ğŸ’¾ Save</button>
            <button type="button" class="btn-secondary" onclick="toggleTicketEdit()">âœ– Cancel</button>
        </div>
    </form>
</div>

<!-- Repositories Section -->
{% if repos and repos|length > 0 %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title"><span class="icon">ğŸ“</span> Repositories</h2>
    </div>
    <div class="repo-list">
        {% for repo in repos %}
        <div class="repo-item">
            <span class="repo-path">{{ repo.repo_path }}</span>
            {% if repo.base_branch %}
            <span class="todo-status pending">{{ repo.base_branch }}</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- 2-Pane Layout for TODOs and Scraps -->
<div class="two-pane-layout">
    <!-- TODOs Section (Left) -->
    <div class="card" id="todos-section">
        {% include "partials/todo_list.html" %}
    </div>

    <!-- Scraps Section (Right) -->
    <div class="card" id="scraps-section">
        {% include "partials/scrap_list.html" %}
    </div>
</div>
{% else %}
<!-- No Task State -->
<div class="no-task">
    <div class="icon">ğŸ“‹</div>
    <h2>No Active Task</h2>
    <p>Create a new task or switch to an existing one to get started.</p>
    <p style="margin-top: 1rem;">
        Run <code>track new "Task name"</code> to create a new task.
    </p>
</div>
{% endif %}

<script>
    function toggleDescEdit() {
        const display = document.getElementById('desc-display');
        const form = document.getElementById('desc-edit-form');
        if (form.style.display === 'none') {
            display.style.display = 'none';
            form.style.display = 'block';
            form.querySelector('textarea').focus();
        } else {
            display.style.display = 'block';
            form.style.display = 'none';
        }
    }

    function toggleTicketEdit() {
        const display = document.getElementById('ticket-display');
        const form = document.getElementById('ticket-edit-form');
        if (form.style.display === 'none') {
            display.style.display = 'none';
            form.style.display = 'block';
            form.querySelector('input[name="ticket_id"]').focus();
        } else {
            display.style.display = 'block';
            form.style.display = 'none';
        }
    }
</script>
{% endblock %}